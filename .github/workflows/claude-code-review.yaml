name: Claude Code Review
on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  actions: read
  issues: write
  id-token: write
  pull-requests: write

jobs:
  code-review:
    runs-on: ${{ vars.RUNNER_STANDARD }}
    if: |
      (
        github.event_name == 'pull_request' &&
        vars.CLAUDE_REVIEW_CONFIG != '' &&
        fromJSON(vars.CLAUDE_REVIEW_CONFIG)[format('{0}:{1}', github.base_ref, github.event.action)] == true
      ) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude'))
    steps:
      - uses: actions/checkout@v4

      - uses: ./
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_app_id: ${{ vars.TWO_INC_APP_ID }}
          github_app_private_key: ${{ secrets.TWO_INC_APP_PRIVATE_KEY }}
          extra_prompt: |

              ## Repo-Specific Guidelines:

              This is the claude-code-reviewer action itself - a composite GitHub Action (action.yml) wrapping anthropics/claude-code-action@v1.
              - action.yml is the only source file. There is no build step, no JS/TS
              - Keep it a pure passthrough to upstream - no filtering/gating logic in the action itself
              - The review prompt in action.yml is the most critical part - changes to it affect all consuming repos
              - Pay attention to prompt clarity and whether instructions could be misinterpreted by the LLM
